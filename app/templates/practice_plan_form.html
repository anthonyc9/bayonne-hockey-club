{% extends "base.html" %}

{% block title %}{{ title }} - Bayonne Hockey Club{% endblock %}

{% block scripts %}
<script>
let selectedFiles = [];
let currentBrowseFolderId = null;
let folderStack = [];

// Initialize file browser when browse tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const browseTab = document.getElementById('browse-tab');
    if (browseTab) {
        browseTab.addEventListener('shown.bs.tab', function() {
            if (currentBrowseFolderId === null) {
                loadRootFolder();
            }
        });
    }
});

function searchFiles() {
    const searchTerm = document.getElementById('fileSearch').value.trim();
    if (!searchTerm) {
        alert('Please enter a search term');
        return;
    }
    
    // Show loading state
    const resultsDiv = document.getElementById('fileSearchResults');
    resultsDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Searching...</div>';
    resultsDiv.style.display = 'block';
    
    // Search files via API
    fetch(`/files/search?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.files.length > 0) {
                displaySearchResults(data.files);
            } else {
                resultsDiv.innerHTML = '<div class="text-muted">No files found matching your search.</div>';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            resultsDiv.innerHTML = '<div class="text-danger">Error searching files. Please try again.</div>';
        });
}

function displaySearchResults(files) {
    const resultsDiv = document.getElementById('fileSearchResults');
    let html = '<div class="list-group">';
    
    files.forEach(file => {
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-file-earmark"></i>
                    <strong>${file.original_name}</strong>
                    <small class="text-muted d-block">${file.mime_type} â€¢ ${formatFileSize(file.file_size)}</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFile('${file.id}', '${file.original_name}')">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
}

function addFile(fileId, fileName) {
    // Check if file is already selected
    if (selectedFiles.find(f => f.id === fileId)) {
        alert('This file is already selected');
        return;
    }
    
    // Add to selected files
    selectedFiles.push({ id: fileId, name: fileName });
    updateSelectedFilesDisplay();
    updateHiddenInput();
}

function removeFile(fileId) {
    selectedFiles = selectedFiles.filter(f => f.id !== fileId);
    updateSelectedFilesDisplay();
    updateHiddenInput();
}

function updateSelectedFilesDisplay() {
    const listDiv = document.getElementById('selectedFilesList');
    
    if (selectedFiles.length === 0) {
        listDiv.innerHTML = '<p class="text-muted mb-0">No files selected</p>';
        return;
    }
    
    let html = '';
    selectedFiles.forEach(file => {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                <span><i class="bi bi-file-earmark"></i> ${file.name}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile('${file.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
    });
    
    listDiv.innerHTML = html;
}

function updateHiddenInput() {
    const attachmentIds = selectedFiles.map(f => f.id).join(',');
    document.getElementById('attachmentIds').value = attachmentIds;
}


function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}


function loadFolderContents(folderId) {
    currentBrowseFolderId = folderId;
    
    // Show loading state
    const browserDiv = document.getElementById('fileBrowser');
    browserDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading...</div>';
    
    // Fetch folder contents
    const url = folderId ? `/files/browse/${folderId}` : '/files/browse';
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFolderContents(data.folders, data.files, folderId);
                updatePathDisplay(folderId);
            } else {
                browserDiv.innerHTML = '<div class="text-danger">Error loading folder contents.</div>';
            }
        })
        .catch(error => {
            console.error('Browse error:', error);
            browserDiv.innerHTML = '<div class="text-danger">Error loading folder contents.</div>';
        });
}

function displayFolderContents(folders, files, folderId) {
    const browserDiv = document.getElementById('fileBrowser');
    let html = '';
    
    // Display folders first
    if (folders && folders.length > 0) {
        html += '<div class="mb-2"><strong class="text-muted">Folders:</strong></div>';
        folders.forEach(folder => {
            html += `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div class="d-flex align-items-center" style="cursor: pointer;" onclick="openFolder(${folder.id})">
                        <i class="bi bi-folder2 text-warning me-2"></i>
                        <span>${folder.name}</span>
                    </div>
                </div>
            `;
        });
    }
    
    // Display files
    if (files && files.length > 0) {
        html += '<div class="mb-2 mt-3"><strong class="text-muted">Files:</strong></div>';
        files.forEach(file => {
            const isSelected = selectedFiles.find(f => f.id === file.id);
            html += `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark text-primary me-2"></i>
                        <span>${file.original_name}</span>
                        <small class="text-muted ms-2">${formatFileSize(file.file_size)}</small>
                    </div>
                    <button type="button" class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-primary'}" 
                            onclick="toggleFileSelection('${file.id}', '${file.original_name}')">
                        <i class="bi ${isSelected ? 'bi-check' : 'bi-plus'}"></i>
                        ${isSelected ? 'Selected' : 'Add'}
                    </button>
                </div>
            `;
        });
    }
    
    if ((!folders || folders.length === 0) && (!files || files.length === 0)) {
        html = '<div class="text-muted text-center py-3">This folder is empty</div>';
    }
    
    browserDiv.innerHTML = html;
}

function openFolder(folderId) {
    // Add current folder to stack for navigation
    if (currentBrowseFolderId !== null) {
        folderStack.push(currentBrowseFolderId);
    }
    
    // Show parent folder button
    document.getElementById('parentFolderBtn').style.display = 'block';
    
    // Load the new folder
    loadFolderContents(folderId);
}

function goToParentFolder() {
    if (folderStack.length > 0) {
        const parentFolderId = folderStack.pop();
        loadFolderContents(parentFolderId);
        
        // Hide parent folder button if we're back at root
        if (folderStack.length === 0) {
            document.getElementById('parentFolderBtn').style.display = 'none';
        }
    } else {
        // Go to root
        loadRootFolder();
        document.getElementById('parentFolderBtn').style.display = 'none';
    }
}

function updatePathDisplay(folderId) {
    const pathSpan = document.getElementById('currentPath');
    if (folderId === null) {
        pathSpan.textContent = 'Root';
    } else {
        // For now, just show the folder ID. In a full implementation, you could fetch the full path
        pathSpan.textContent = `Folder ID: ${folderId}`;
    }
}

function toggleFileSelection(fileId, fileName) {
    const existingIndex = selectedFiles.findIndex(f => f.id === fileId);
    
    if (existingIndex >= 0) {
        // Remove file
        selectedFiles.splice(existingIndex, 1);
    } else {
        // Add file
        selectedFiles.push({ id: fileId, name: fileName });
    }
    
    updateSelectedFilesDisplay();
    updateHiddenInput();
    
    // Refresh the browser display to update button states
    if (currentBrowseFolderId !== null) {
        loadFolderContents(currentBrowseFolderId);
    }
}

// Load existing attachments if editing
{% if practice_plan and practice_plan.attachments %}
document.addEventListener('DOMContentLoaded', function() {
    {% for attachment in practice_plan.attachments %}
    selectedFiles.push({ id: '{{ attachment.id }}', name: '{{ attachment.original_name }}' });
    {% endfor %}
    updateSelectedFilesDisplay();
    updateHiddenInput();
});
{% endif %}

// Handle form submission to ensure selected files are included
document.querySelector('form').addEventListener('submit', function(e) {
    updateHiddenInput();
});


function createDrillPieceElement(index) {
    console.log('Creating drill piece element with index:', index);
    const div = document.createElement('div');
    div.className = 'drill-piece-item card mb-3';
    div.setAttribute('data-index', index);
    
    div.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-activity"></i> Drill Piece #${index + 1}
            </h6>
            <button type="button" class="btn btn-sm btn-outline-danger remove-drill-piece">
                <i class="bi bi-trash"></i> Remove
            </button>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Time</label>
                    <input type="text" name="drill_pieces-${index}-time" class="form-control" placeholder="e.g., 10 minutes, 5-10 min">
                </div>
                <div class="col-md-9">
                    <label class="form-label">Drill Name</label>
                    <input type="text" name="drill_pieces-${index}-drill_name" class="form-control" placeholder="e.g., Skating Drills, Passing Practice">
                </div>
                <div class="col-12">
                    <label class="form-label">Description</label>
                    <textarea name="drill_pieces-${index}-description" class="form-control" rows="3" placeholder="Describe the drill, setup, and objectives..."></textarea>
                </div>
                <div class="col-12">
                    <label class="form-label">Link/Attachment</label>
                    <input type="text" name="drill_pieces-${index}-link_attachment" class="form-control" placeholder="URL or file reference (optional)">
                </div>
            </div>
        </div>
    `;
    
    // Add remove event listener
    div.querySelector('.remove-drill-piece').addEventListener('click', function() {
        div.remove();
        updateDrillPieceNumbers();
        updateRemoveButtons();
    });
    
    return div;
}

function updateDrillPieceNumbers() {
    const drillPieces = document.querySelectorAll('.drill-piece-item');
    drillPieces.forEach((piece, index) => {
        const header = piece.querySelector('.card-header h6');
        header.innerHTML = `<i class="bi bi-activity"></i> Drill Piece #${index + 1}`;
        piece.setAttribute('data-index', index);
        
        // Update form field names
        const inputs = piece.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            const name = input.name;
            if (name) {
                const parts = name.split('-');
                parts[1] = index;
                input.name = parts.join('-');
            }
        });
    });
}

function updateRemoveButtons() {
    const drillPieces = document.querySelectorAll('.drill-piece-item');
    const removeButtons = document.querySelectorAll('.remove-drill-piece');
    
    removeButtons.forEach(button => {
        button.disabled = drillPieces.length <= 1;
    });
}

</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-calendar-event"></i> {{ title }}
                        </h4>
                        <div>
                            <span class="badge bg-primary">{{ team.name }}</span>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <form method="POST">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="row">
                            <!-- Basic Information -->
                            <div class="col-md-6">
                                <h5 class="mb-3">Basic Information</h5>
                                
                                <div class="mb-3">
                                    <label for="title" class="form-label">{{ form.title.label }}</label>
                                    {{ form.title(class="form-control", placeholder="e.g., Skating Fundamentals") }}
                                    {% if form.title.errors %}
                                        <div class="text-danger">
                                            {% for error in form.title.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="date" class="form-label">{{ form.date.label }}</label>
                                    {{ form.date(class="form-control", type="date") }}
                                    {% if form.date.errors %}
                                        <div class="text-danger">
                                            {% for error in form.date.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="duration" class="form-label">{{ form.duration.label }}</label>
                                    {{ form.duration(class="form-control", placeholder="e.g., 60 minutes") }}
                                    {% if form.duration.errors %}
                                        <div class="text-danger">
                                            {% for error in form.duration.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Focus Areas -->
                            <div class="col-md-6">
                                <h5 class="mb-3">Focus Areas</h5>
                                
                                <div class="mb-3">
                                    <label for="primary_focus" class="form-label">{{ form.primary_focus.label }}</label>
                                    {{ form.primary_focus(class="form-select") }}
                                    {% if form.primary_focus.errors %}
                                        <div class="text-danger">
                                            {% for error in form.primary_focus.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <div class="mb-3">
                                    <label for="secondary_focus" class="form-label">{{ form.secondary_focus.label }}</label>
                                    {{ form.secondary_focus(class="form-select") }}
                                    {% if form.secondary_focus.errors %}
                                        <div class="text-danger">
                                            {% for error in form.secondary_focus.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Practice Structure - Dynamic Drill Pieces -->
                        <h5 class="mb-3">
                            <i class="bi bi-list-ol"></i> Practice Structure
                            <small class="text-muted">Add as many drill pieces as needed</small>
                        </h5>
                        
                        <div id="drill-pieces-container">
                            {% for drill_form in form.drill_pieces %}
                                <div class="drill-piece-item card mb-3" data-index="{{ loop.index0 }}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="bi bi-activity"></i> Drill Piece #{{ loop.index }}
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-outline-danger remove-drill-piece" 
                                                {% if loop.length == 1 %}disabled{% endif %}>
                                            <i class="bi bi-trash"></i> Remove
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label">Time</label>
                                                {% if drill_form.time is callable %}
                                                    {{ drill_form.time(class="form-control") }}
                                                {% else %}
                                                    <input type="text" name="drill_pieces-{{ loop.index0 }}-time" class="form-control" placeholder="e.g., 10 minutes, 5-10 min">
                                                {% endif %}
                                                {% if drill_form.time.errors %}
                                                    <div class="text-danger">
                                                        {% for error in drill_form.time.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-md-9">
                                                <label class="form-label">Drill Name</label>
                                                {% if drill_form.drill_name is callable %}
                                                    {{ drill_form.drill_name(class="form-control") }}
                                                {% else %}
                                                    <input type="text" name="drill_pieces-{{ loop.index0 }}-drill_name" class="form-control" placeholder="e.g., Skating Drills, Passing Practice">
                                                {% endif %}
                                                {% if drill_form.drill_name.errors %}
                                                    <div class="text-danger">
                                                        {% for error in drill_form.drill_name.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Description</label>
                                                {% if drill_form.description is callable %}
                                                    {{ drill_form.description(class="form-control") }}
                                                {% else %}
                                                    <textarea name="drill_pieces-{{ loop.index0 }}-description" class="form-control" rows="3" placeholder="Describe the drill, setup, and objectives..."></textarea>
                                                {% endif %}
                                                {% if drill_form.description.errors %}
                                                    <div class="text-danger">
                                                        {% for error in drill_form.description.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="col-12">
                                                <label class="form-label">Link/Attachment</label>
                                                {% if drill_form.link_attachment is callable %}
                                                    {{ drill_form.link_attachment(class="form-control") }}
                                                {% else %}
                                                    <input type="text" name="drill_pieces-{{ loop.index0 }}-link_attachment" class="form-control" placeholder="URL or file reference (optional)">
                                                {% endif %}
                                                {% if drill_form.link_attachment.errors %}
                                                    <div class="text-danger">
                                                        {% for error in drill_form.link_attachment.errors %}
                                                            <small>{{ error }}</small>
                                                        {% endfor %}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        
                        <div class="text-center mb-4">
                            <button type="button" class="btn btn-outline-primary" id="add-drill-piece">
                                <i class="bi bi-plus-circle"></i> Add Another Drill Piece
                            </button>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Additional Information -->
                        <h5 class="mb-3">Additional Information</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="equipment_needed" class="form-label">{{ form.equipment_needed.label }}</label>
                                    {{ form.equipment_needed(class="form-control", rows="3", placeholder="e.g., Cones, Pucks, Sticks") }}
                                    {% if form.equipment_needed.errors %}
                                        <div class="text-danger">
                                            {% for error in form.equipment_needed.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="external_links" class="form-label">{{ form.external_links.label }}</label>
                                    {{ form.external_links(class="form-control", rows="3", placeholder="One link per line...") }}
                                    {% if form.external_links.errors %}
                                        <div class="text-danger">
                                            {% for error in form.external_links.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Enter one external link per line</small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="additional_notes" class="form-label">{{ form.additional_notes.label }}</label>
                            {{ form.additional_notes(class="form-control", rows="3", placeholder="Any additional notes or instructions...") }}
                            {% if form.additional_notes.errors %}
                                <div class="text-danger">
                                    {% for error in form.additional_notes.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- File Attachments -->
                        <h5 class="mb-3">File Attachments</h5>
                        <div class="mb-3">
                            <label class="form-label">File Attachments</label>
                            
                            <!-- File Options Tabs -->
                            <ul class="nav nav-tabs mb-3" id="attachmentTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="existing-tab" data-bs-toggle="tab" data-bs-target="#existing-pane" type="button" role="tab">
                                        <i class="bi bi-folder2-open"></i> Find Existing File
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="upload-tab" data-bs-toggle="tab" data-bs-target="#upload-pane" type="button" role="tab">
                                        <i class="bi bi-upload"></i> Upload New File
                                    </button>
                                </li>
                            </ul>
                            
                            <!-- Tab Content -->
                            <div class="tab-content" id="attachmentTabContent">
                                <!-- Find Existing File Tab -->
                                <div class="tab-pane fade show active" id="existing-pane" role="tabpanel">
                                    <div class="input-group mb-3">
                                        <input type="text" id="fileSearch" class="form-control" placeholder="Search existing files...">
                                        <button type="button" class="btn btn-outline-secondary" onclick="searchFiles()">
                                            <i class="bi bi-search"></i> Search
                                        </button>
                                    </div>
                                    
                                    <!-- File Browser -->
                                    <div class="mb-2">
                                        <div class="d-flex align-items-center mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="goToParentFolder()" id="parentFolderBtn" style="display: none;">
                                                <i class="bi bi-arrow-up"></i> Up
                                            </button>
                                            <span class="text-muted" id="currentPath">Root</span>
                                        </div>
                                    </div>
                                    
                                    <div id="fileBrowser" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                                        <p class="text-muted text-center">Click "Load Files" to browse existing files</p>
                                    </div>
                                    
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadRootFolder()">
                                            <i class="bi bi-house"></i> Load Files
                                        </button>
                                    </div>
                                    
                                    <div id="fileSearchResults" class="mt-3" style="display: none;">
                                        <h6>Search Results:</h6>
                                        <div id="searchResultsList" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                            <!-- Search results will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Upload New File Tab -->
                                <div class="tab-pane fade" id="upload-pane" role="tabpanel">
                                    <div class="mb-3">
                                        <label for="fileUpload" class="form-label">Choose File to Upload</label>
                                        <input type="file" class="form-control" id="fileUpload" name="file" accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.mp4,.mov,.avi">
                                        <div class="form-text">Supported formats: PDF, DOC, DOCX, TXT, JPG, PNG, GIF, MP4, MOV, AVI</div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="uploadDescription" class="form-label">Description (Optional)</label>
                                        <input type="text" class="form-control" id="uploadDescription" name="upload_description" placeholder="Brief description of the file">
                                    </div>
                                    
                                    <button type="button" class="btn btn-primary" onclick="uploadFile()">
                                        <i class="bi bi-upload"></i> Upload File
                                    </button>
                                    
                                    <div id="uploadStatus" class="mt-2" style="display: none;">
                                        <!-- Upload status will be shown here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Selected Files Display -->
                            <div id="selectedFiles" class="mt-3">
                                <label class="form-label">Selected Files:</label>
                                <div id="selectedFilesList" class="border rounded p-2 min-h-100">
                                    <p class="text-muted mb-0">No files selected</p>
                                </div>
                            </div>
                            <input type="hidden" id="attachmentIds" name="attachment_ids" value="">
                            
                            {% if practice_plan and practice_plan.attachments %}
                            <div class="mt-3">
                                <label class="form-label">Current Attachments:</label>
                                <div class="border rounded p-2">
                                    {% for attachment in practice_plan.attachments %}
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                                        <span><i class="bi bi-file-earmark"></i> {{ attachment.original_name }}</span>
                                        <small class="text-muted">{{ attachment.mime_type }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                {% if practice_plan %}Update Practice Plan{% else %}Create Practice Plan{% endif %}
                            </button>
                            <a href="{{ url_for('main.team_practice_plans', team_id=team.id) }}" class="btn btn-secondary">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Drill Pieces Management
let drillPieceIndex = {{ form.drill_pieces|length }};

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing drill pieces...');
    
    // Add drill piece button
    const addButton = document.getElementById('add-drill-piece');
    console.log('Add button found:', addButton);
    
    if (addButton) {
        addButton.addEventListener('click', function() {
            console.log('Add button clicked!');
            const container = document.getElementById('drill-pieces-container');
            console.log('Container found:', container);
            const newDrillPiece = createDrillPieceElement(drillPieceIndex);
            container.appendChild(newDrillPiece);
            drillPieceIndex++;
            updateRemoveButtons();
        });
    } else {
        console.error('Add button not found!');
    }
    
    // Remove drill piece buttons
    document.querySelectorAll('.remove-drill-piece').forEach(button => {
        button.addEventListener('click', function() {
            this.closest('.drill-piece-item').remove();
            updateDrillPieceNumbers();
            updateRemoveButtons();
        });
    });
    updateRemoveButtons();
});

function createDrillPieceElement(index) {
    console.log('Creating drill piece element with index:', index);
    const div = document.createElement('div');
    div.className = 'drill-piece-item card mb-3';
    div.setAttribute('data-index', index);
    
    div.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
                <i class="bi bi-activity"></i> Drill Piece #${index + 1}
            </h6>
            <button type="button" class="btn btn-sm btn-outline-danger remove-drill-piece">
                <i class="bi bi-trash"></i> Remove
            </button>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Time</label>
                    <input type="text" name="drill_pieces-${index}-time" class="form-control" placeholder="e.g., 10 minutes, 5-10 min">
                </div>
                <div class="col-md-9">
                    <label class="form-label">Drill Name</label>
                    <input type="text" name="drill_pieces-${index}-drill_name" class="form-control" placeholder="e.g., Skating Drills, Passing Practice">
                </div>
                <div class="col-12">
                    <label class="form-label">Description</label>
                    <textarea name="drill_pieces-${index}-description" class="form-control" rows="3" placeholder="Describe the drill, setup, and objectives..."></textarea>
                </div>
                <div class="col-12">
                    <label class="form-label">Link/Attachment</label>
                    <input type="text" name="drill_pieces-${index}-link_attachment" class="form-control" placeholder="URL or file reference (optional)">
                </div>
            </div>
        </div>
    `;
    
    // Add remove event listener
    div.querySelector('.remove-drill-piece').addEventListener('click', function() {
        div.remove();
        updateDrillPieceNumbers();
        updateRemoveButtons();
    });
    
    return div;
}

function updateDrillPieceNumbers() {
    const drillPieces = document.querySelectorAll('.drill-piece-item');
    drillPieces.forEach((piece, index) => {
        const header = piece.querySelector('.card-header h6');
        header.innerHTML = `<i class="bi bi-activity"></i> Drill Piece #${index + 1}`;
        piece.setAttribute('data-index', index);
        
        // Update form field names
        const inputs = piece.querySelectorAll('input, textarea');
        inputs.forEach(input => {
            const name = input.name;
            if (name) {
                const parts = name.split('-');
                parts[1] = index;
                input.name = parts.join('-');
            }
        });
    });
}

function updateRemoveButtons() {
    const drillPieces = document.querySelectorAll('.drill-piece-item');
    const removeButtons = document.querySelectorAll('.remove-drill-piece');
    
    removeButtons.forEach(button => {
        button.disabled = drillPieces.length <= 1;
    });
}

// File Upload Function
function uploadFile() {
    
    const fileInput = document.getElementById('fileUpload');
    const descriptionInput = document.getElementById('uploadDescription');
    const statusDiv = document.getElementById('uploadStatus');
    
    console.log('Upload function called');
    console.log('File input:', fileInput);
    console.log('Files:', fileInput.files);
    
    if (!fileInput.files[0]) {
        alert('Please select a file to upload');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    if (descriptionInput.value) {
        formData.append('description', descriptionInput.value);
    }
    
    console.log('FormData created, sending request...');
    
    statusDiv.style.display = 'block';
    statusDiv.innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Uploading file...</div>';
    
    fetch('/files/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('Response received:', response);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            statusDiv.innerHTML = '<div class="alert alert-success"><i class="bi bi-check-circle"></i> File uploaded successfully!</div>';
            
            // Add the uploaded file to selected files
            selectedFiles.push({ id: data.file_id, name: data.filename });
            updateSelectedFilesDisplay();
            updateHiddenInput();
            
            // Clear the form
            fileInput.value = '';
            descriptionInput.value = '';
            
            // Hide status after 3 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
        } else {
            statusDiv.innerHTML = `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Upload failed: ${data.error}</div>`;
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        statusDiv.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Upload failed. Please try again.</div>';
    });
}

// File Browser Function
function loadRootFolder() {
    console.log('loadRootFolder called');
    currentBrowseFolderId = null;
    folderStack = [];
    
    // Show loading state
    const browserDiv = document.getElementById('fileBrowser');
    console.log('Browser div:', browserDiv);
    browserDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading...</div>';
    
    // Fetch root folder contents
    console.log('Fetching /files/browse...');
    fetch('/files/browse')
        .then(response => {
            console.log('Browse response:', response);
            return response.json();
        })
        .then(data => {
            console.log('Browse data:', data);
            if (data.success) {
                displayFolderContents(data.folders, data.files, null);
                updatePathDisplay(null);
            } else {
                browserDiv.innerHTML = '<div class="text-danger">Error loading files.</div>';
            }
        })
        .catch(error => {
            console.error('Browse error:', error);
            browserDiv.innerHTML = '<div class="text-danger">Error loading files.</div>';
        });
}

// Missing file browser functions
function displayFolderContents(folders, files, folderId) {
    const browserDiv = document.getElementById('fileBrowser');
    let html = '';
    
    // Display folders first
    if (folders && folders.length > 0) {
        html += '<div class="mb-2"><strong class="text-muted">Folders:</strong></div>';
        folders.forEach(folder => {
            html += `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div class="d-flex align-items-center" style="cursor: pointer;" onclick="openFolder(${folder.id})">
                        <i class="bi bi-folder2 text-warning me-2"></i>
                        <span>${folder.name}</span>
                    </div>
                </div>
            `;
        });
    }
    
    // Display files
    if (files && files.length > 0) {
        html += '<div class="mb-2 mt-3"><strong class="text-muted">Files:</strong></div>';
        files.forEach(file => {
            const isSelected = selectedFiles.find(f => f.id === file.id);
            html += `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark text-primary me-2"></i>
                        <span>${file.original_name}</span>
                        <small class="text-muted ms-2">${formatFileSize(file.file_size)}</small>
                    </div>
                    <button type="button" class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-primary'}" 
                            onclick="toggleFileSelection('${file.id}', '${file.original_name}')">
                        <i class="bi ${isSelected ? 'bi-check' : 'bi-plus'}"></i>
                        ${isSelected ? 'Selected' : 'Add'}
                    </button>
                </div>
            `;
        });
    }
    
    if ((!folders || folders.length === 0) && (!files || files.length === 0)) {
        html = '<div class="text-muted text-center py-3">This folder is empty</div>';
    }
    
    browserDiv.innerHTML = html;
}

function updatePathDisplay(folderId) {
    const pathElement = document.getElementById('currentPath');
    const parentBtn = document.getElementById('parentFolderBtn');
    
    if (folderId === null) {
        pathElement.textContent = 'Root';
        parentBtn.style.display = 'none';
    } else {
        pathElement.textContent = `Folder ${folderId}`;
        parentBtn.style.display = 'inline-block';
    }
}

function openFolder(folderId) {
    // Add current folder to stack for navigation
    if (currentBrowseFolderId !== null) {
        folderStack.push(currentBrowseFolderId);
    }
    loadFolderContents(folderId);
}

function loadFolderContents(folderId) {
    currentBrowseFolderId = folderId;
    
    // Show loading state
    const browserDiv = document.getElementById('fileBrowser');
    browserDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading...</div>';
    
    // Fetch folder contents
    const url = folderId ? `/files/browse/${folderId}` : '/files/browse';
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFolderContents(data.folders, data.files, folderId);
                updatePathDisplay(folderId);
            } else {
                browserDiv.innerHTML = '<div class="text-danger">Error loading folder contents.</div>';
            }
        })
        .catch(error => {
            console.error('Browse error:', error);
            browserDiv.innerHTML = '<div class="text-danger">Error loading folder contents.</div>';
        });
}

function toggleFileSelection(fileId, fileName) {
    const existingFile = selectedFiles.find(f => f.id === fileId);
    if (existingFile) {
        removeFile(fileId);
    } else {
        addFile(fileId, fileName);
    }
}

function addFile(fileId, fileName) {
    // Check if file is already selected
    if (selectedFiles.some(f => f.id === fileId)) {
        return;
    }
    
    selectedFiles.push({ id: fileId, name: fileName });
    updateSelectedFilesDisplay();
    updateHiddenInput();
}

function removeFile(fileId) {
    selectedFiles = selectedFiles.filter(f => f.id !== fileId);
    updateSelectedFilesDisplay();
    updateHiddenInput();
}

function updateSelectedFilesDisplay() {
    const selectedFilesList = document.getElementById('selectedFilesList');
    selectedFilesList.innerHTML = '';
    
    selectedFiles.forEach(file => {
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-file-earmark me-2"></i>
                <span>${file.name}</span>
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="removeFile(${file.id})">
                <i class="bi bi-x"></i>
            </button>
        `;
        selectedFilesList.appendChild(li);
    });
}
</script>
{% endblock %}
