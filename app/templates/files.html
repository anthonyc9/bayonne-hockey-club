{% extends "base.html" %}

{% block title %}Files - Bayonne Hockey Club{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Statistics -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
                <h1 class="h3 mb-0"><i class="bi bi-folder"></i> File Manager</h1>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">
                        <i class="bi bi-cloud-upload"></i> Upload Files
                    </button>
                    <button class="btn btn-primary" onclick="createNewFolder()">
                        <i class="bi bi-folder-plus"></i> New Folder
                    </button>
                </div>
            </div>
            

        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Breadcrumb Navigation -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('main.files') }}">
                            <i class="bi bi-house"></i> Home
                        </a>
                    </li>
                    {% for folder in breadcrumbs %}
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('main.files', folder_id=folder.id) }}">{{ folder.name }}</a>
                        </li>
                    {% endfor %}
                    {% if current_folder %}
                        <li class="breadcrumb-item active" aria-current="page">{{ current_folder.name }}</li>
                    {% endif %}
                </ol>
            </nav>
        </div>
    </div>



    <!-- Files and Folders Grid -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="bi bi-grid-3x3-gap"></i> 
                    {% if current_folder %}
                        {{ current_folder.name }}
                    {% else %}
                        Root Directory
                    {% endif %}
                </h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" id="gridViewBtn" onclick="setView('grid')">
                        <i class="bi bi-grid-3x3-gap"></i> Grid
                    </button>
                    <button class="btn btn-outline-primary" id="listViewBtn" onclick="setView('list')">
                        <i class="bi bi-list"></i> List
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            
            <!-- Grid View -->
            <div id="gridView">
                <div class="row g-3">
                    <!-- Folders -->
                    {% for folder in folders %}
                        <div class="col-xl-2 col-lg-3 col-md-4 col-6">
                            <div class="card folder-card h-100" onclick="openFolder({{ folder.id }})">
                                <div class="card-body text-center p-3">
                                    <div class="folder-icon mb-2">
                                        <i class="bi bi-folder-fill text-{{ folder.color }}" style="font-size: 3rem;"></i>
                                    </div>
                                    <h6 class="card-title mb-1">{{ folder.name }}</h6>
                                    <small class="text-muted">{{ folder.file_count }} items</small>
                                    <div class="folder-actions mt-2">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary btn-sm" onclick="event.stopPropagation(); editFolder({{ folder.id }}, '{{ folder.name }}', '{{ folder.description or '' }}', '{{ folder.color }}')">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger btn-sm" onclick="event.stopPropagation(); deleteFolder({{ folder.id }}, '{{ folder.name }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Files -->
                    {% for file in files %}
                        <div class="col-xl-2 col-lg-3 col-md-4 col-6">
                            <div class="card file-card h-100">
                                <div class="card-body text-center p-3">
                                    {% if file.is_image %}
                                        <div class="file-thumbnail mb-2">
                                            <img src="{{ url_for('main.download_file', file_id=file.id) }}" 
                                                 alt="{{ file.original_name }}" 
                                                 class="img-fluid rounded"
                                                 style="max-height: 80px; object-fit: cover;">
                                        </div>
                                    {% else %}
                                        <div class="file-icon mb-2">
                                            <i class="{{ file.icon_class }}" style="font-size: 3rem; color: #6c757d;"></i>
                                        </div>
                                    {% endif %}
                                    <h6 class="card-title mb-1" title="{{ file.original_name }}">
                                        {{ file.original_name[:20] }}{% if file.original_name|length > 20 %}...{% endif %}
                                    </h6>
                                    <small class="text-muted d-block">{{ file.formatted_size }}</small>
                                    <small class="text-muted d-block">{{ file.created_at.strftime('%m/%d/%Y') }}</small>
                                    <div class="file-actions mt-2">
                                        <div class="btn-group-vertical btn-group-sm w-100">
                                            <a href="{{ url_for('main.download_file', file_id=file.id) }}" 
                                               class="btn btn-outline-success btn-sm">
                                                <i class="bi bi-download"></i> Download
                                            </a>
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    onclick="deleteFile({{ file.id }}, '{{ file.original_name }}')">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <!-- Empty State -->
                    {% if not folders and not files %}
                        <div class="col-12">
                            <div class="text-center py-5">
                                <i class="bi bi-folder2-open display-4 text-muted"></i>
                                <h5 class="mt-3 text-muted">This folder is empty</h5>
                                <p class="text-muted">Upload some files or create folders to get started</p>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                                    <i class="bi bi-cloud-upload"></i> Upload Files
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- List View -->
            <div id="listView" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Size</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Folders -->
                            {% for folder in folders %}
                                <tr class="folder-row" onclick="openFolder({{ folder.id }})">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="bi bi-folder-fill text-{{ folder.color }} me-2"></i>
                                            <strong>{{ folder.name }}</strong>
                                        </div>
                                    </td>
                                    <td><span class="badge bg-secondary">Folder</span></td>
                                    <td>{{ folder.file_count }} items</td>
                                    <td>{{ folder.updated_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="event.stopPropagation(); editFolder({{ folder.id }}, '{{ folder.name }}', '{{ folder.description or '' }}', '{{ folder.color }}')">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" onclick="event.stopPropagation(); deleteFolder({{ folder.id }}, '{{ folder.name }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}

                            <!-- Files -->
                            {% for file in files %}
                                <tr class="file-row">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="{{ file.icon_class }} me-2"></i>
                                            {{ file.original_name }}
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{ file.file_extension.upper() or 'FILE' }}</span>
                                    </td>
                                    <td>{{ file.formatted_size }}</td>
                                    <td>{{ file.created_at.strftime('%m/%d/%Y %I:%M %p') }}</td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <a href="{{ url_for('main.download_file', file_id=file.id) }}" 
                                               class="btn btn-outline-success">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            <button class="btn btn-outline-danger" 
                                                    onclick="deleteFile({{ file.id }}, '{{ file.original_name }}')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}

                            {% if not folders and not files %}
                                <tr>
                                    <td colspan="5" class="text-center py-4 text-muted">
                                        <i class="bi bi-folder2-open"></i> This folder is empty
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Files</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="upload-area" id="modalDropZone">
                    <div class="text-center py-4">
                        <i class="bi bi-cloud-upload display-4 text-primary"></i>
                        <h5 class="mt-3">Drag files here or click to browse</h5>
                        <p class="text-muted">Maximum file size: 50MB per file</p>
                        <input type="file" id="fileInput" multiple class="d-none">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="bi bi-file-plus"></i> Choose Files
                        </button>
                    </div>
                </div>
                
                <!-- Upload Progress -->
                <div id="uploadProgress" style="display: none;">
                    <h6>Uploading Files:</h6>
                    <div id="progressList"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Folder Modal -->
<div class="modal fade" id="folderModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="folderModalTitle">Create New Folder</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="folderForm">
                    <div class="mb-3">
                        <label for="folderName" class="form-label">Folder Name</label>
                        <input type="text" class="form-control" id="folderName" required>
                    </div>
                    <div class="mb-3">
                        <label for="folderDescription" class="form-label">Description (Optional)</label>
                        <textarea class="form-control" id="folderDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="folderColor" class="form-label">Folder Color</label>
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="folderColor" id="color-primary" value="primary" checked>
                            <label class="btn btn-outline-primary" for="color-primary">Blue</label>
                            
                            <input type="radio" class="btn-check" name="folderColor" id="color-success" value="success">
                            <label class="btn btn-outline-success" for="color-success">Green</label>
                            
                            <input type="radio" class="btn-check" name="folderColor" id="color-warning" value="warning">
                            <label class="btn btn-outline-warning" for="color-warning">Yellow</label>
                            
                            <input type="radio" class="btn-check" name="folderColor" id="color-danger" value="danger">
                            <label class="btn btn-outline-danger" for="color-danger">Red</label>
                            
                            <input type="radio" class="btn-check" name="folderColor" id="color-info" value="info">
                            <label class="btn btn-outline-info" for="color-info">Cyan</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFolderForm()">Save Folder</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Are you sure you want to delete this item?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>

<style>
.stats-card-mobile .card-body {
    padding: 0.75rem 0.5rem;
}

.folder-card, .file-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid #dee2e6;
}

.folder-card:hover, .file-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.folder-row {
    cursor: pointer;
}

.folder-row:hover {
    background-color: #f8f9fa;
}

#dropZone {
    border: 2px dashed #dee2e6;
    transition: all 0.3s ease;
}

#dropZone.drag-over {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 2rem;
    transition: all 0.3s ease;
}

.upload-area.drag-over {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.file-thumbnail img {
    max-width: 100%;
    height: 80px;
    object-fit: cover;
}

.folder-actions, .file-actions {
    opacity: 0;
    transition: opacity 0.2s ease;
}

.folder-card:hover .folder-actions,
.file-card:hover .file-actions {
    opacity: 1;
}

@media (max-width: 768px) {
    .folder-actions, .file-actions {
        opacity: 1;
    }
    
    .stats-card-mobile h4 {
        font-size: 1.2rem;
    }
    
    .stats-card-mobile small {
        font-size: 0.75rem;
    }
}

.progress-item {
    margin-bottom: 1rem;
}

.progress-item:last-child {
    margin-bottom: 0;
}
</style>

<script>
let currentFolderId = {{ current_folder.id if current_folder else 'null' }};
// Convert 'null' string to actual null for JavaScript
if (currentFolderId === 'null') {
    currentFolderId = null;
}
let editingFolderId = null;

// View toggle functionality
function setView(view) {
    const gridView = document.getElementById('gridView');
    const listView = document.getElementById('listView');
    const gridBtn = document.getElementById('gridViewBtn');
    const listBtn = document.getElementById('listViewBtn');
    
    if (view === 'grid') {
        gridView.style.display = 'block';
        listView.style.display = 'none';
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
    } else {
        gridView.style.display = 'none';
        listView.style.display = 'block';
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
    }
    
    localStorage.setItem('fileViewMode', view);
}

// Folder operations
function openFolder(folderId) {
    window.location.href = `/files/${folderId}`;
}

function createNewFolder() {
    editingFolderId = null;
    document.getElementById('folderModalTitle').textContent = 'Create New Folder';
    document.getElementById('folderName').value = '';
    document.getElementById('folderDescription').value = '';
    document.querySelector('input[name="folderColor"][value="primary"]').checked = true;
    new bootstrap.Modal(document.getElementById('folderModal')).show();
}

function editFolder(folderId, name, description, color) {
    editingFolderId = folderId;
    document.getElementById('folderModalTitle').textContent = 'Edit Folder';
    document.getElementById('folderName').value = name;
    document.getElementById('folderDescription').value = description;
    document.querySelector(`input[name="folderColor"][value="${color}"]`).checked = true;
    new bootstrap.Modal(document.getElementById('folderModal')).show();
}

function saveFolderForm() {
    const name = document.getElementById('folderName').value.trim();
    const description = document.getElementById('folderDescription').value.trim();
    const color = document.querySelector('input[name="folderColor"]:checked').value;
    
    if (!name) {
        alert('Please enter a folder name');
        return;
    }
    
    const data = {
        name: name,
        description: description,
        color: color,
        parent_id: currentFolderId
    };
    
    // Add CSRF token to headers
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    const headers = {
        'Content-Type': 'application/json',
    };
    
    if (csrfToken) {
        data.csrf_token = csrfToken.getAttribute('content');
    }
    
    fetch('/files/create-folder', {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to create folder');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to create folder');
    });
}

function deleteFolder(folderId, folderName) {
    document.getElementById('deleteMessage').textContent = 
        `Are you sure you want to delete the folder "${folderName}" and all its contents? This action cannot be undone.`;
    
    document.getElementById('confirmDeleteBtn').onclick = function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/files/delete-folder/${folderId}`;
        
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    };
    
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function deleteFile(fileId, fileName) {
    document.getElementById('deleteMessage').textContent = 
        `Are you sure you want to delete "${fileName}"? This action cannot be undone.`;
    
    document.getElementById('confirmDeleteBtn').onclick = function() {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/files/delete/${fileId}`;
        
        // Add folder_id to redirect back to current folder
        const folderInput = document.createElement('input');
        folderInput.type = 'hidden';
        folderInput.name = 'folder_id';
        folderInput.value = currentFolderId || '';
        form.appendChild(folderInput);
        
        const csrfToken = document.querySelector('meta[name=csrf-token]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrf_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    };
    
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

// File upload functionality
function initializeFileUpload() {
    console.log('=== INITIALIZING FILE UPLOAD ===');
    const fileInput = document.getElementById('fileInput');
    
    console.log('fileInput:', fileInput);
    
    // Simplified - only file input functionality
    
    // Removed drag-and-drop functionality since we don't have drop zones
    
    // File input change
    if (fileInput) {
        console.log('Adding change event listener to fileInput');
        fileInput.addEventListener('change', function(e) {
            console.log('=== FILE INPUT CHANGED ===');
            console.log('Files selected:', e.target.files.length);
            const files = Array.from(e.target.files);
            uploadFiles(files);
        });
    } else {
        console.error('fileInput element not found!');
    }
    
    // Click to upload on main drop zone
    dropZone.addEventListener('click', function() {
        new bootstrap.Modal(document.getElementById('uploadModal')).show();
    });
}

function uploadFiles(files) {
    console.log('=== UPLOADFILES CALLED ===');
    console.log('Number of files:', files.length);
    console.log('Files:', Array.from(files).map(f => f.name));
    
    const uploadProgress = document.getElementById('uploadProgress');
    const progressList = document.getElementById('progressList');
    
    console.log('Upload progress element:', uploadProgress);
    console.log('Progress list element:', progressList);
    
    uploadProgress.style.display = 'block';
    progressList.innerHTML = '';
    
    files.forEach((file, index) => {
        console.log('Processing file:', file.name);
        const progressItem = document.createElement('div');
        progressItem.className = 'progress-item';
        progressItem.innerHTML = `
            <div class="d-flex justify-content-between mb-1">
                <span class="file-name">${file.name}</span>
                <span class="file-status">Uploading...</span>
            </div>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
        `;
        progressList.appendChild(progressItem);
        
        uploadFile(file, progressItem, index === files.length - 1);
    });
}

function uploadFile(file, progressItem, isLast) {
    console.log('=== JAVASCRIPT UPLOAD DEBUG ===');
    console.log('File:', file.name, file.size);
    console.log('Current folder ID:', currentFolderId);
    
    const formData = new FormData();
    formData.append('file', file);
    // Send folder_id only if it's a valid folder
    if (currentFolderId && currentFolderId !== null) {
        formData.append('folder_id', currentFolderId);
    }
    // Don't send folder_id at all for root folder - let backend handle as None
    
    console.log('FormData created, about to fetch...');
    
    const progressBar = progressItem.querySelector('.progress-bar');
    const statusSpan = progressItem.querySelector('.file-status');
    
    // Add CSRF token to FormData
    const csrfToken = document.querySelector('meta[name=csrf-token]');
    if (csrfToken) {
        formData.append('csrf_token', csrfToken.getAttribute('content'));
    }
    
    fetch('/files/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.redirected || response.status === 302) {
            // User was redirected (likely to login page)
            window.location.href = response.url || '/login';
            return;
        }
        return response.json();
    })
    .then(data => {
        if (!data) return; // Handle redirect case
        if (data.success) {
            progressBar.style.width = '100%';
            progressBar.classList.add('bg-success');
            statusSpan.textContent = 'Complete';
            statusSpan.className = 'file-status text-success';
            
            if (isLast) {
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            progressBar.classList.add('bg-danger');
            statusSpan.textContent = data.error || 'Failed';
            statusSpan.className = 'file-status text-danger';
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        progressBar.classList.add('bg-danger');
        statusSpan.textContent = 'Error';
        statusSpan.className = 'file-status text-danger';
    });
}

// Initialize everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeFileUpload();
    
    // Restore view mode preference
    const savedView = localStorage.getItem('fileViewMode') || 'grid';
    setView(savedView);
});
</script>

{% endblock %}
