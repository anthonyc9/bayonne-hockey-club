{% extends "base.html" %}

{% block title %}{{ title }} - Bayonne Hockey Club{% endblock %}

{% block extra_css %}
<style>
.practice-plan-card {
    height: 100%;
    transition: all 0.2s ease;
}

.practice-plan-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.practice-plan-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.practice-plan-badge {
    font-size: 0.9rem;
    padding: 0.5rem 1rem;
}

.sidebar-card {
    height: fit-content;
}

/* Mobile Responsiveness Improvements */
@media (max-width: 991.98px) {
    .sidebar-card {
        margin-top: 1rem;
    }
    
    /* Improve breadcrumb spacing on mobile */
    .breadcrumb {
        font-size: 0.875rem;
        padding: 0.5rem 0;
    }
    
    /* Better button spacing on mobile */
    .btn-group-mobile {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    /* Improve metadata display on mobile */
    .metadata-mobile {
        flex-direction: column;
        align-items: flex-start !important;
        gap: 0.5rem !important;
    }
}

@media (max-width: 576px) {
    /* Extra small screens */
    .breadcrumb {
        font-size: 0.8rem;
    }
    
    .breadcrumb-item {
        padding: 0.25rem 0.5rem;
    }
    
    /* Stack buttons vertically on very small screens */
    .btn-group-mobile {
        width: 100%;
    }
    
    .btn-group-mobile .btn {
        width: 100%;
        margin-bottom: 0.25rem;
    }
    
    /* Improve title spacing */
    h1.h2 {
        font-size: 1.5rem;
        line-height: 1.3;
    }
}

/* Breadcrumb improvements */
.breadcrumb {
    background: transparent;
    padding: 0.75rem 0;
    margin-bottom: 0;
}

.breadcrumb-item + .breadcrumb-item::before {
    content: "â€º";
    color: #6c757d;
    font-weight: bold;
}

.breadcrumb-item a {
    color: #0d6efd;
    transition: color 0.15s ease-in-out;
}

.breadcrumb-item a:hover {
    color: #0a58ca;
}

.breadcrumb-item.active {
    color: #6c757d;
}

/* Drill Pieces Styling */
.drill-piece-item {
    transition: all 0.2s ease;
    border-left: 4px solid #0d6efd !important;
}

.drill-piece-item:hover {
    transform: translateX(2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.drill-piece-item:nth-child(even) {
    border-left-color: #6f42c1 !important;
}

.drill-piece-item:nth-child(odd) {
    border-left-color: #0d6efd !important;
}

.drill-pieces-list .badge {
    min-width: 80px;
    font-size: 0.85rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header with Breadcrumbs -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-2">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('main.practice_plans') }}" class="text-decoration-none">
                            <i class="bi bi-house me-1"></i>Plans
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('main.team_practice_plans', team_id=practice_plan.team.id) }}" class="text-decoration-none">
                            {{ practice_plan.team.name }}
                        </a>
                    </li>
                    <li class="breadcrumb-item active text-truncate" style="max-width: 200px;" title="{{ practice_plan.title }}">
                        {{ practice_plan.title }}
                    </li>
                </ol>
            </nav>
            
            <!-- Header Section -->
            <div class="mb-4">
                <!-- Title and Metadata - Full Width, Left Aligned -->
                <div class="mb-3">
                    <h1 class="h2 mb-2 text-start">{{ practice_plan.title }}</h1>
                    <div class="d-flex flex-wrap align-items-center gap-3 text-start metadata-mobile">
                        <span class="text-muted">
                            <i class="bi bi-calendar me-1"></i>
                            {{ practice_plan.date.strftime('%A, %B %d, %Y') }}
                        </span>
                        {% if practice_plan.duration %}
                            <span class="text-muted">
                                <i class="bi bi-clock me-1"></i>
                                {{ practice_plan.duration }}
                            </span>
                        {% endif %}
                        <span class="badge bg-primary fs-6">{{ practice_plan.team.name }}</span>
                    </div>
                </div>
                
                <!-- Action Buttons - Responsive Layout -->
                <div class="d-flex flex-wrap gap-2 justify-content-start btn-group-mobile">
                    <a href="{{ url_for('main.edit_practice_plan', plan_id=practice_plan.id) }}" class="btn btn-primary btn-sm">
                        <i class="bi bi-pencil me-1"></i> Edit
                    </a>
                    <a href="{{ url_for('main.print_practice_plan', plan_id=practice_plan.id) }}?v={{ practice_plan.id }}" class="btn btn-success btn-sm" target="_blank">
                        <i class="bi bi-printer me-1"></i> Print
                    </a>
                    <button class="btn btn-danger btn-sm" onclick="deletePracticePlan({{ practice_plan.id }}, '{{ practice_plan.title }}')">
                        <i class="bi bi-trash me-1"></i> Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Practice Plan Details -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Practice Plan Details</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="text-center p-3 border rounded bg-light practice-plan-card">
                                <div class="text-center mb-2">
                                    <i class="bi bi-target practice-plan-icon text-primary"></i>
                                </div>
                                <h6 class="text-center fw-bold text-muted mb-2">Primary Focus</h6>
                                <div>
                                    <span class="badge bg-primary practice-plan-badge">{{ practice_plan.primary_focus }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="text-center p-3 border rounded bg-light practice-plan-card">
                                <div class="text-center mb-2">
                                    <i class="bi bi-target practice-plan-icon text-secondary"></i>
                                </div>
                                <h6 class="text-center fw-bold text-muted mb-2">Secondary Focus</h6>
                                <div>
                                    {% if practice_plan.secondary_focus and practice_plan.secondary_focus != 'N/A' %}
                                        <span class="badge bg-secondary practice-plan-badge">{{ practice_plan.secondary_focus }}</span>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Practice Structure - Drill Pieces -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-ol"></i> Practice Structure</h5>
                </div>
                <div class="card-body">
                    {% if practice_plan.drill_pieces %}
                        <div class="drill-pieces-list">
                            {% for drill in practice_plan.drill_pieces|sort(attribute='order_index') %}
                                <div class="drill-piece-item border rounded p-3 mb-3 {% if loop.index % 2 == 0 %}bg-light{% endif %}">
                                    <div class="row align-items-start">
                                        <div class="col-md-2 col-sm-3">
                                            <div class="text-center">
                                                <div class="badge bg-primary fs-6 mb-2">{{ drill.time }}</div>
                                                <div class="text-muted small">#{{ loop.index }}</div>
                                            </div>
                                        </div>
                                        <div class="col-md-10 col-sm-9">
                                            <h6 class="fw-bold mb-2 text-primary">{{ drill.drill_name }}</h6>
                                            {% if drill.description %}
                                                <p class="mb-2">{{ drill.description }}</p>
                                            {% endif %}
                                            {% if drill.link_attachment %}
                                                <div class="mt-2">
                                                    <a href="{{ drill.link_attachment }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-link-45deg me-1"></i> View Link/Attachment
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <!-- Fallback to legacy structure if no drill pieces -->
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="h-100 p-3 border rounded bg-light">
                                    <div class="text-center mb-2">
                                        <i class="bi bi-clock text-warning fs-4"></i>
                                    </div>
                                    <h6 class="text-center fw-bold text-muted mb-2">Warm Up</h6>
                                    <div class="text-center">
                                        {% if practice_plan.warm_up %}
                                            <p class="mb-0">{{ practice_plan.warm_up }}</p>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="h-100 p-3 border rounded bg-light">
                                    <div class="text-center mb-2">
                                        <i class="bi bi-list-ul text-primary fs-4"></i>
                                    </div>
                                    <h6 class="text-center fw-bold text-muted mb-2">Main Content</h6>
                                    <div class="text-center">
                                        {% if practice_plan.main_content %}
                                            <p class="mb-0">{{ practice_plan.main_content }}</p>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="h-100 p-3 border rounded bg-light">
                                    <div class="text-center mb-2">
                                        <i class="bi bi-snow text-info fs-4"></i>
                                    </div>
                                    <h6 class="text-center fw-bold text-muted mb-2">Cool Down</h6>
                                    <div class="text-center">
                                        {% if practice_plan.cool_down %}
                                            <p class="mb-0">{{ practice_plan.cool_down }}</p>
                                        {% else %}
                                            <span class="text-muted">Not specified</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Additional Information -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-gear"></i> Additional Information</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="h-100 p-3 border rounded bg-light">
                                <div class="text-center mb-2">
                                    <i class="bi bi-tools text-info fs-4"></i>
                                </div>
                                <h6 class="text-center fw-bold text-muted mb-2">Equipment Needed</h6>
                                <div class="text-center">
                                    {% if practice_plan.equipment_needed %}
                                        <p class="mb-0">{{ practice_plan.equipment_needed }}</p>
                                    {% else %}
                                        <span class="text-muted">Not specified</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="h-100 p-3 border rounded bg-light">
                                <div class="text-center mb-2">
                                    <i class="bi bi-sticky text-success fs-4"></i>
                                </div>
                                <h6 class="text-center fw-bold text-muted mb-2">Additional Notes</h6>
                                <div class="text-center">
                                    {% if practice_plan.additional_notes %}
                                        <p class="mb-0">{{ practice_plan.additional_notes }}</p>
                                    {% else %}
                                        <span class="text-muted">None</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Attachments -->
            <div class="card mb-4 sidebar-card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-paperclip"></i> Attachments</h6>
                </div>
                <div class="card-body">
                    {% if practice_plan.attachments %}
                        <div class="list-group list-group-flush">
                            {% for attachment in practice_plan.attachments %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <i class="bi bi-file-earmark text-primary me-2"></i>
                                        <a href="{{ url_for('main.download_file', file_id=attachment.id) }}" class="text-decoration-none">
                                            {{ attachment.original_name }}
                                        </a>
                                    </div>
                                    <form method="POST" action="{{ url_for('main.remove_practice_plan_attachment', plan_id=practice_plan.id, file_id=attachment.id) }}" 
                                          style="display: inline;" onsubmit="return confirm('Remove this attachment?')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </form>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted mb-0 text-center py-3">No attachments</p>
                    {% endif %}
                    
                    <hr>
                    
                    <!-- Add Attachment Button -->
                    <div class="text-center">
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAttachmentModal">
                            <i class="bi bi-plus"></i> Add Attachment
                        </button>
                    </div>
                </div>
            </div>

            <!-- External Links -->
            {% if practice_plan.external_links %}
                <div class="card mb-4 sidebar-card">
                    <div class="card-header">
                        <h6 class="mb-0"><i class="bi bi-link-45deg"></i> External Links</h6>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for link in practice_plan.external_links.split(',') %}
                                <a href="{{ link.strip() }}" target="_blank" class="list-group-item list-group-item-action d-flex align-items-center">
                                    <i class="bi bi-box-arrow-up-right text-primary me-2"></i>
                                    <span class="text-truncate">{{ link.strip() }}</span>
                                </a>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Quick Actions -->
            <div class="card sidebar-card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-lightning"></i> Quick Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('main.edit_practice_plan', plan_id=practice_plan.id) }}" class="btn btn-primary">
                            <i class="bi bi-pencil"></i> Edit Plan
                        </a>
                        <a href="{{ url_for('main.print_practice_plan', plan_id=practice_plan.id) }}?v={{ practice_plan.id }}" class="btn btn-success" target="_blank">
                            <i class="bi bi-printer"></i> Print Plan
                        </a>
                        <a href="{{ url_for('main.team_practice_plans', team_id=practice_plan.team.id) }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Team
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Attachment Modal -->
<div class="modal fade" id="addAttachmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Attachment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Search and select files from your file library to attach to this practice plan.</p>
                
                <!-- File Search and Browse Tabs -->
                <ul class="nav nav-tabs mb-3" id="attachmentTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="search-tab" data-bs-toggle="tab" data-bs-target="#search-pane" type="button" role="tab">
                            <i class="bi bi-search"></i> Search Files
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="browse-tab" data-bs-toggle="tab" data-bs-target="#browse-pane" type="button" role="tab">
                            <i class="bi bi-folder2-open"></i> Browse Files
                        </button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="attachmentTabContent">
                    <!-- Search Tab -->
                    <div class="tab-pane fade show active" id="search-pane" role="tabpanel">
                        <div class="mb-3">
                            <label for="fileSearch" class="form-label">Search Files</label>
                            <div class="input-group">
                                <input type="text" id="fileSearch" class="form-control" placeholder="Search files by name or description...">
                                <button type="button" class="btn btn-outline-secondary" onclick="searchFiles()">
                                    <i class="bi bi-search"></i> Search
                                </button>
                            </div>
                        </div>
                        
                        <!-- Search Results -->
                        <div id="fileSearchResults" class="mb-3" style="display: none;">
                            <!-- Search results will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Browse Tab -->
                    <div class="tab-pane fade" id="browse-pane" role="tabpanel">
                        <div class="mb-3">
                            <label class="form-label">Browse File Library</label>
                            <div class="d-flex align-items-center mb-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="goToParentFolder()" id="parentFolderBtn" style="display: none;">
                                    <i class="bi bi-arrow-up"></i> Up
                                </button>
                                <span class="text-muted" id="currentPath">Root</span>
                            </div>
                        </div>
                        
                        <!-- Folder and File Browser -->
                        <div id="fileBrowser" class="border rounded p-2" style="max-height: 300px; overflow-y: auto;">
                            <!-- Browser content will be populated here -->
                        </div>
                        
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="loadRootFolder()">
                                <i class="bi bi-house"></i> Go to Root
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Selected Files -->
                <div class="mb-3">
                    <label class="form-label">Selected Files:</label>
                    <div id="selectedFilesList" class="border rounded p-2 min-h-100">
                        <p class="text-muted mb-0">No files selected</p>
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    <strong>Note:</strong> You can also upload new files in the Files section and then attach them here.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSelectedAttachments()">Add Selected Files</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deletePracticePlanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Practice Plan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="deletePracticePlanTitle"></strong>?</p>
                <p class="text-danger"><small>This action cannot be undone.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" id="deletePracticePlanForm" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    <button type="submit" class="btn btn-danger">Delete Practice Plan</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function deletePracticePlan(planId, planTitle) {
    document.getElementById('deletePracticePlanTitle').textContent = planTitle;
    document.getElementById('deletePracticePlanForm').action = "{{ url_for('main.delete_practice_plan', plan_id=0) }}".replace('0', planId);
    new bootstrap.Modal(document.getElementById('deletePracticePlanModal')).show();
}

let selectedFiles = [];
let currentBrowseFolderId = null;
let folderStack = [];

// Initialize file browser when browse tab is shown
document.addEventListener('DOMContentLoaded', function() {
    const browseTab = document.getElementById('browse-tab');
    browseTab.addEventListener('shown.bs.tab', function() {
        if (currentBrowseFolderId === null) {
            loadRootFolder();
        }
    });
});

function searchFiles() {
    const searchTerm = document.getElementById('fileSearch').value.trim();
    if (!searchTerm) {
        alert('Please enter a search term');
        return;
    }
    
    // Show loading state
    const resultsDiv = document.getElementById('fileSearchResults');
    resultsDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Searching...</div>';
    resultsDiv.style.display = 'block';
    
    // Search files via API
    fetch(`/files/search?q=${encodeURIComponent(searchTerm)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.files.length > 0) {
                displaySearchResults(data.files);
            } else {
                resultsDiv.innerHTML = '<div class="text-muted">No files found matching your search.</div>';
            }
        })
        .catch(error => {
            console.error('Search error:', error);
            resultsDiv.innerHTML = '<div class="text-danger">Error searching files. Please try again.</div>';
        });
}

function displaySearchResults(files) {
    const resultsDiv = document.getElementById('fileSearchResults');
    let html = '<div class="list-group">';
    
    files.forEach(file => {
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    <i class="bi bi-file-earmark"></i>
                    <strong>${file.original_name}</strong>
                    <small class="text-muted d-block">${file.mime_type} â€¢ ${formatFileSize(file.file_size)}</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="addFile('${file.id}', '${file.original_name}')">
                    <i class="bi bi-plus"></i> Add
                </button>
            </div>
        `;
    });
    
    html += '</div>';
    resultsDiv.innerHTML = html;
}

function addFile(fileId, fileName) {
    // Check if file is already selected
    if (selectedFiles.find(f => f.id === fileId)) {
        alert('This file is already selected');
        return;
    }
    
    // Add to selected files
    selectedFiles.push({ id: fileId, name: fileName });
    updateSelectedFilesDisplay();
}

function removeFile(fileId) {
    selectedFiles = selectedFiles.filter(f => f.id !== fileId);
    updateSelectedFilesDisplay();
}

function updateSelectedFilesDisplay() {
    const listDiv = document.getElementById('selectedFilesList');
    
    if (selectedFiles.length === 0) {
        listDiv.innerHTML = '<p class="text-muted mb-0">No files selected</p>';
        return;
    }
    
    let html = '';
    selectedFiles.forEach(file => {
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
                <span><i class="bi bi-file-earmark"></i> ${file.name}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile('${file.id}')">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
    });
    
    listDiv.innerHTML = html;
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// File Browser Functions
function loadRootFolder() {
    currentBrowseFolderId = null;
    folderStack = [];
    loadFolderContents(null);
}

function loadFolderContents(folderId) {
    currentBrowseFolderId = folderId;
    
    // Show loading state
    const browserDiv = document.getElementById('fileBrowser');
    browserDiv.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading...</div>';
    
    // Fetch folder contents
    const url = folderId ? `/files/browse/${folderId}` : '/files/browse';
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayFolderContents(data.folders, data.files, folderId);
                updatePathDisplay(folderId);
            } else {
                browserDiv.innerHTML = '<div class="text-danger">Error loading folder contents.</div>';
            }
        })
        .catch(error => {
            console.error('Browse error:', error);
            browserDiv.innerHTML = '<div class="text-danger">Error loading folder contents.</div>';
        });
}

function displayFolderContents(folders, files, folderId) {
    const browserDiv = document.getElementById('fileBrowser');
    let html = '';
    
    // Display folders first
    if (folders && folders.length > 0) {
        html += '<div class="mb-2"><strong class="text-muted">Folders:</strong></div>';
        folders.forEach(folder => {
            html += `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div class="d-flex align-items-center" style="cursor: pointer;" onclick="openFolder(${folder.id})">
                        <i class="bi bi-folder2 text-warning me-2"></i>
                        <span>${folder.name}</span>
                    </div>
                </div>
            `;
        });
    }
    
    // Display files
    if (files && files.length > 0) {
        html += '<div class="mb-2 mt-3"><strong class="text-muted">Files:</strong></div>';
        files.forEach(file => {
            const isSelected = selectedFiles.find(f => f.id === file.id);
            html += `
                <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-file-earmark text-primary me-2"></i>
                        <span>${file.original_name}</span>
                        <small class="text-muted ms-2">${formatFileSize(file.file_size)}</small>
                    </div>
                    <button type="button" class="btn btn-sm ${isSelected ? 'btn-success' : 'btn-outline-primary'}" 
                            onclick="toggleFileSelection('${file.id}', '${file.original_name}')">
                        <i class="bi ${isSelected ? 'bi-check' : 'bi-plus'}"></i>
                        ${isSelected ? 'Selected' : 'Add'}
                    </button>
                </div>
            `;
        });
    }
    
    if ((!folders || folders.length === 0) && (!files || files.length === 0)) {
        html = '<div class="text-muted text-center py-3">This folder is empty</div>';
    }
    
    browserDiv.innerHTML = html;
}

function openFolder(folderId) {
    // Add current folder to stack for navigation
    if (currentBrowseFolderId !== null) {
        folderStack.push(currentBrowseFolderId);
    }
    
    // Show parent folder button
    document.getElementById('parentFolderBtn').style.display = 'block';
    
    // Load the new folder
    loadFolderContents(folderId);
}

function goToParentFolder() {
    if (folderStack.length > 0) {
        const parentFolderId = folderStack.pop();
        loadFolderContents(parentFolderId);
        
        // Hide parent folder button if we're back at root
        if (folderStack.length === 0) {
            document.getElementById('parentFolderBtn').style.display = 'none';
        }
    } else {
        // Go to root
        loadRootFolder();
        document.getElementById('parentFolderBtn').style.display = 'none';
    }
}

function updatePathDisplay(folderId) {
    const pathSpan = document.getElementById('currentPath');
    if (folderId === null) {
        pathSpan.textContent = 'Root';
    } else {
        // For now, just show the folder ID. In a full implementation, you could fetch the full path
        pathSpan.textContent = `Folder ID: ${folderId}`;
    }
}

function toggleFileSelection(fileId, fileName) {
    const existingIndex = selectedFiles.findIndex(f => f.id === fileId);
    
    if (existingIndex >= 0) {
        // Remove file
        selectedFiles.splice(existingIndex, 1);
    } else {
        // Add file
        selectedFiles.push({ id: fileId, name: fileName });
    }
    
    updateSelectedFilesDisplay();
    
    // Refresh the browser display to update button states
    if (currentBrowseFolderId !== null) {
        loadFolderContents(currentBrowseFolderId);
    }
}

function addSelectedAttachments() {
    if (selectedFiles.length === 0) {
        alert('Please select at least one file to attach.');
        return;
    }
    
    // Create a form and submit it with all selected files
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = "{{ url_for('main.add_practice_plan_attachment', plan_id=practice_plan.id) }}";
    
    // Add CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrf_token';
    csrfInput.value = document.querySelector('meta[name=csrf-token]').getAttribute('content');
    form.appendChild(csrfInput);
    
    // Add each selected file
    selectedFiles.forEach(file => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'file_ids[]';
        input.value = file.id;
        form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
}
</script>
{% endblock %}
