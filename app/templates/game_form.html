{% extends "base.html" %}

{% block title %}{{ title }} - Bayonne Hockey Club{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0"><i class="bi bi-trophy"></i> {{ title }}</h1>
                <a href="{{ url_for('main.game_tracker') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Games
                </a>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- Game Form -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">Game Information</h6>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {{ form.hidden_tag() }}
                        
                        <div class="row g-3">
                            <!-- Game Date -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.game_date.label }}</label>
                                {{ form.game_date(class="form-control") }}
                                {% if form.game_date.errors %}
                                    <div class="text-danger">
                                        {% for error in form.game_date.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Team -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.team_name.label }}</label>
                                {{ form.team_name(class="form-select") }}
                                {% if form.team_name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.team_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Opponent Team -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.opponent_team.label }}</label>
                                {{ form.opponent_team(class="form-control") }}
                                {% if form.opponent_team.errors %}
                                    <div class="text-danger">
                                        {% for error in form.opponent_team.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Game Status -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.game_status.label }}</label>
                                {{ form.game_status(class="form-select") }}
                                {% if form.game_status.errors %}
                                    <div class="text-danger">
                                        {% for error in form.game_status.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Rink Name -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.rink_name.label }}</label>
                                {{ form.rink_name(class="form-control") }}
                                {% if form.rink_name.errors %}
                                    <div class="text-danger">
                                        {% for error in form.rink_name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Rink Location -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.rink_location.label }}</label>
                                {{ form.rink_location(class="form-control") }}
                                {% if form.rink_location.errors %}
                                    <div class="text-danger">
                                        {% for error in form.rink_location.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Badgers Score -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.badgers_score.label }}</label>
                                {{ form.badgers_score(class="form-control") }}
                                {% if form.badgers_score.errors %}
                                    <div class="text-danger">
                                        {% for error in form.badgers_score.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Opponent Score -->
                            <div class="col-md-6">
                                <label class="form-label">{{ form.opponent_score.label }}</label>
                                {{ form.opponent_score(class="form-control") }}
                                {% if form.opponent_score.errors %}
                                    <div class="text-danger">
                                        {% for error in form.opponent_score.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Notes -->
                            <div class="col-12">
                                <label class="form-label">{{ form.notes.label }}</label>
                                {{ form.notes(class="form-control", rows="3") }}
                                {% if form.notes.errors %}
                                    <div class="text-danger">
                                        {% for error in form.notes.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Goals Section (only show if game is completed) -->
                        <div id="goalsSection" style="display: none;">
                            <hr>
                            <h6 class="mb-3"><i class="bi bi-target"></i> Player Goals & Assists</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Goals</h6>
                                    <div id="goalsList">
                                        <!-- Goals will be added dynamically here -->
                                    </div>
                                    <button type="button" class="btn btn-success btn-sm" onclick="addGoal()">
                                        <i class="bi bi-plus-circle"></i> Add Goal
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <h6>Assists</h6>
                                    <div id="assistsList">
                                        <!-- Assists will be added dynamically here -->
                                    </div>
                                    <button type="button" class="btn btn-info btn-sm" onclick="addAssist()">
                                        <i class="bi bi-plus-circle"></i> Add Assist
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{{ url_for('main.game_tracker') }}" class="btn btn-secondary">Cancel</a>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Goal Entry Modal -->
<div class="modal fade" id="goalModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Goal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="goalForm" onsubmit="event.preventDefault(); saveGoal(); return false;">
                    <div class="mb-3">
                        <label class="form-label">Scorer</label>
                        <select id="goalScorer" class="form-select" required>
                            <option value="">Select Player</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Number of Goals</label>
                        <input type="number" id="goalQuantity" class="form-control" min="1" max="10" value="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveGoal()">Add Goal</button>
            </div>
        </div>
    </div>
</div>

<!-- Assist Entry Modal -->
<div class="modal fade" id="assistModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Assist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assistForm" onsubmit="event.preventDefault(); saveAssist(); return false;">
                    <div class="mb-3">
                        <label class="form-label">Assister</label>
                        <select id="assistAssister" class="form-select" required>
                            <option value="">Select Player</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Number of Assists</label>
                        <input type="number" id="assistQuantity" class="form-control" min="1" max="10" value="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveAssist()">Add Assist</button>
            </div>
        </div>
    </div>
</div>

<script>
let goals = [];
let assists = [];
let teamPlayers = [];

// Get team players when team is selected
document.getElementById('team_name').addEventListener('change', function() {
    const teamName = this.value;
    if (teamName) {
        // This would normally fetch players via AJAX, but for now we'll use a placeholder
        // In a real implementation, you'd make an AJAX call to get players for the selected team
        populatePlayerDropdowns(teamName);
    }
});

// Show/hide goals section based on game status
document.getElementById('game_status').addEventListener('change', function() {
    const goalsSection = document.getElementById('goalsSection');
    if (this.value === 'completed') {
        goalsSection.style.display = 'block';
    } else {
        goalsSection.style.display = 'none';
    }
});

// Check initial game status on page load
document.addEventListener('DOMContentLoaded', function() {
    const gameStatus = document.getElementById('game_status');
    const goalsSection = document.getElementById('goalsSection');
    if (gameStatus.value === 'completed') {
        goalsSection.style.display = 'block';
    }
    
    // Load team players if editing
    const teamName = document.getElementById('team_name').value;
    if (teamName) {
        populatePlayerDropdowns(teamName);
    }
    
    // Load existing goals and assists if editing
    {% if existing_goals %}
        const existingGoals = {{ existing_goals | tojson }};
        goals = existingGoals.map(goal => ({
            scorer_id: goal.scorer_id
        }));
        // Wait for team players to load before updating display
        setTimeout(() => {
            updateGoalsList();
        }, 500);
    {% endif %}
    
    {% if existing_assists %}
        const existingAssists = {{ existing_assists | tojson }};
        assists = existingAssists.map(assist => ({
            assister_id: assist.assister_id
        }));
        // Wait for team players to load before updating display
        setTimeout(() => {
            updateAssistsList();
        }, 500);
    {% endif %}
    
    // Add Enter key handling for modal forms
    document.getElementById('goalQuantity').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveGoal();
        }
    });
    
    document.getElementById('assistQuantity').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            saveAssist();
        }
    });
});

function populatePlayerDropdowns(teamName) {
    // Fetch players for the selected team via AJAX
    fetch(`/api/team-players/${encodeURIComponent(teamName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                teamPlayers = data.players;
                updatePlayerDropdowns();
            } else {
                console.error('Error fetching players:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching players:', error);
        });
}

function updatePlayerDropdowns() {
    // Update goal scorer dropdown
    const goalScorer = document.getElementById('goalScorer');
    goalScorer.innerHTML = '<option value="">Select Player</option>';
    teamPlayers.forEach(player => {
        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = `${player.name} #${player.jersey_number}`;
        goalScorer.appendChild(option);
    });
    
    // Update assist assister dropdown
    const assistAssister = document.getElementById('assistAssister');
    assistAssister.innerHTML = '<option value="">Select Player</option>';
    teamPlayers.forEach(player => {
        const option = document.createElement('option');
        option.value = player.id;
        option.textContent = `${player.name} #${player.jersey_number}`;
        assistAssister.appendChild(option);
    });
}

function addGoal() {
    // Make sure dropdowns are populated before showing modal
    if (teamPlayers.length === 0) {
        const teamName = document.getElementById('team_name').value;
        if (teamName) {
            populatePlayerDropdowns(teamName);
        } else {
            alert('Please select a team first');
            return;
        }
    }
    updatePlayerDropdowns();
    // Reset form and set default quantity
    document.getElementById('goalForm').reset();
    document.getElementById('goalQuantity').value = 1;
    const modal = new bootstrap.Modal(document.getElementById('goalModal'));
    modal.show();
}

function addAssist() {
    // Make sure dropdowns are populated before showing modal
    if (teamPlayers.length === 0) {
        const teamName = document.getElementById('team_name').value;
        if (teamName) {
            populatePlayerDropdowns(teamName);
        } else {
            alert('Please select a team first');
            return;
        }
    }
    updatePlayerDropdowns();
    // Reset form and set default quantity
    document.getElementById('assistForm').reset();
    document.getElementById('assistQuantity').value = 1;
    const modal = new bootstrap.Modal(document.getElementById('assistModal'));
    modal.show();
}

function saveAssist() {
    const assisterId = document.getElementById('assistAssister').value;
    const quantity = parseInt(document.getElementById('assistQuantity').value) || 1;
    
    if (!assisterId) {
        alert('Please select an assister');
        return;
    }
    
    // Add multiple assists for the same player
    for (let i = 0; i < quantity; i++) {
        const assist = {
            assister_id: assisterId
        };
        assists.push(assist);
    }
    
    updateAssistsList();
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('assistModal')).hide();
    
    // Reset form
    document.getElementById('assistForm').reset();
}

function saveGoal() {
    const scorerId = document.getElementById('goalScorer').value;
    const quantity = parseInt(document.getElementById('goalQuantity').value) || 1;
    
    if (!scorerId) {
        alert('Please select a scorer');
        return;
    }
    
    // Add multiple goals for the same player
    for (let i = 0; i < quantity; i++) {
        const goal = {
            scorer_id: scorerId
        };
        goals.push(goal);
    }
    
    updateGoalsList();
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('goalModal')).hide();
    
    // Reset form
    document.getElementById('goalForm').reset();
}

function updateGoalsList() {
    const goalsList = document.getElementById('goalsList');
    goalsList.innerHTML = '';
    
    // Group goals by player
    const goalsByPlayer = {};
    goals.forEach(goal => {
        const playerId = goal.scorer_id;
        if (!goalsByPlayer[playerId]) {
            goalsByPlayer[playerId] = 0;
        }
        goalsByPlayer[playerId]++;
    });
    
    // Display goals by player
    Object.keys(goalsByPlayer).forEach(playerId => {
        const player = teamPlayers.find(p => p.id == playerId);
        const playerName = player ? player.name : `Player ${playerId}`;
        const goalCount = goalsByPlayer[playerId];
        
        const goalDiv = document.createElement('div');
        goalDiv.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light text-dark rounded';
        goalDiv.innerHTML = `
            <span>${playerName}: ${goalCount} goal${goalCount > 1 ? 's' : ''}</span>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePlayerGoals('${playerId}')">
                <i class="bi bi-trash"></i>
            </button>
        `;
        goalsList.appendChild(goalDiv);
    });
}

function updateAssistsList() {
    const assistsList = document.getElementById('assistsList');
    assistsList.innerHTML = '';
    
    // Group assists by player
    const assistsByPlayer = {};
    assists.forEach(assist => {
        const playerId = assist.assister_id;
        if (!assistsByPlayer[playerId]) {
            assistsByPlayer[playerId] = 0;
        }
        assistsByPlayer[playerId]++;
    });
    
    // Display assists by player
    Object.keys(assistsByPlayer).forEach(playerId => {
        const player = teamPlayers.find(p => p.id == playerId);
        const playerName = player ? player.name : `Player ${playerId}`;
        const assistCount = assistsByPlayer[playerId];
        
        const assistDiv = document.createElement('div');
        assistDiv.className = 'd-flex justify-content-between align-items-center mb-2 p-2 bg-light text-dark rounded';
        assistDiv.innerHTML = `
            <span>${playerName}: ${assistCount} assist${assistCount > 1 ? 's' : ''}</span>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removePlayerAssists('${playerId}')">
                <i class="bi bi-trash"></i>
            </button>
        `;
        assistsList.appendChild(assistDiv);
    });
}

function removePlayerGoals(playerId) {
    goals = goals.filter(goal => goal.scorer_id != playerId);
    updateGoalsList();
}

function removePlayerAssists(playerId) {
    assists = assists.filter(assist => assist.assister_id != playerId);
    updateAssistsList();
}

// Add hidden inputs for goals and assists when form is submitted
document.querySelector('form').addEventListener('submit', function(e) {
    // Add goals as hidden inputs
    goals.forEach((goal, index) => {
        const goalInput = document.createElement('input');
        goalInput.type = 'hidden';
        goalInput.name = `goal_${index}`;
        goalInput.value = JSON.stringify(goal);
        this.appendChild(goalInput);
    });
    
    // Add assists as hidden inputs
    assists.forEach((assist, index) => {
        const assistInput = document.createElement('input');
        assistInput.type = 'hidden';
        assistInput.name = `assist_${index}`;
        assistInput.value = JSON.stringify(assist);
        this.appendChild(assistInput);
    });
});
</script>
{% endblock %}
